version: 2.1

workflows:
  export:
    jobs:
      - export

# Exports environment variables to an age-encrypted file using a user's public
# SSH keys fetched from GitHub.
#
# This is being used to investigate KIM-1511. Credentials are being exported so
# that we can use those credentials to call endpoints like AWS STS
# GetCallerIdentity and trace the origin of those credentials. This pipeline is
# indistinguishable from a malicious actor - please contact Kaluza DevEx or
# SecEng if you have any concerns.
#
# Decrypt the exported file with:
# $ age --decrypt -i ~/.ssh/keys/id_ed25519_github
jobs:
  export:
    docker:
      - image: cimg/base:2023.01
    steps:
      - checkout
      - run: sudo apt-get update && sudo apt-get install -y age
      - run: curl https://github.com/borntyping-corporate.keys > borntyping-corporate.keys
      - run: env | age --armor --recipients-file borntyping-corporate.keys -
